<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>상품 페이지</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $.ajaxSetup({
            xhrFields: {
                withCredentials: true
            }
        });

        $(document).ready(function () {
            function fetchProducts() {
                $.ajax({
                    url: '/api/products',
                    method: 'GET',
                    success: function (products) {
                        let html = `
                    <table class="table table-striped table-hover mt-4">
                        <thead class="table-dark">
                            <tr>
                                <th>이름</th>
                                <th>가격</th>
                                <th>이미지</th>
                                <th>위시리스트 추가</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                        for (const product of products) {
                            html += `
                        <tr>
                            <td>${product.name}</td>
                            <td>${product.price.toLocaleString()}원</td>
                            <td><img src="${product.imageURL}" alt="img" width="60" height="60" class="rounded shadow-sm"></td>
                            <td><button class="btn btn-warning btn-sm addBtn" data-id="${product.id}">추가</button></td>
                        </tr>
                    `;
                        }
                        html += `</tbody></table>`;
                        $('#result').html(html);

                        // 이벤트 위임 방식 바인딩
                        $('.addBtn').on('click', function () {
                            const productId = $(this).data('id');
                            const quantity = prompt("수량을 입력하세요:", "1");

                            $.ajax({
                                url: '/api/wish-products',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    productId: productId,
                                    quantity: Number(quantity)
                                }),
                                success: function () {
                                    alert("위시리스트에 추가되었습니다.");
                                },
                                error: function (xhr) {
                                    const response = xhr.responseJSON;
                                    let message = "추가 실패";

                                    if (response) {
                                        if (response.fieldErrors) {
                                            message = Object.values(response.fieldErrors).join('\n');
                                        } else if (response.globalErrors) {
                                            message = response.globalErrors.map(err => err.message).join('\n');
                                        }
                                    }

                                    alert(message);
                                }
                            });
                        });
                    },
                    error: function () {
                        $('#result').html('<div class="alert alert-danger">상품 목록을 불러오는 데 실패했습니다.</div>');
                    }
                });
            }

            fetchProducts();
        });
    </script>
</head>

<body class="bg-light">
<!-- 공통 헤더 포함 -->
<div th:replace="~{fragments/header.html}"></div>
<div class="container mt-5">
    <h1 class="text-center text-primary fw-bold mb-4">상품 페이지</h1>
    <hr>
    <div id="result"></div>
</div>
</body>
</html>
