<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚´ ìœ„ì‹œë¦¬ìŠ¤íŠ¸</title>
  <link rel="stylesheet" th:href="@{/css/kakao-style.css}"/>
</head>
<body>

<h1>ğŸ ë‚´ ìœ„ì‹œë¦¬ìŠ¤íŠ¸</h1>

<div class="top-bar">
  <div class="user-info">
    <span th:text="${userEmail}">user@example.com</span>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!
  </div>
  <a href="/members/products" class="button">ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ</a>
  <a href="/members/logout" class="button">ë¡œê·¸ì•„ì›ƒ</a>
</div>

<table>
  <thead>
  <tr>
    <th>ìƒí’ˆëª…</th>
    <th>ê°€ê²©</th>
    <th>ì´ë¯¸ì§€</th>
    <th>ê´€ë¦¬</th>
  </tr>
  </thead>
  <tbody id="wishlist-body">
  </tbody>
</table>

<div class="pagination" id="pagination-controls">
</div>

<script>
  const token = localStorage.getItem('accessToken');
  const wishlistBody = document.getElementById('wishlist-body');
  const paginationControls = document.getElementById('pagination-controls');

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  async function fetchWishlist(page = 0) {
    if (!token) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      window.location.href = '/members/login';
      return;
    }

    try {
      const response = await fetch(`/api/wishes?page=${page}&size=5&sort=created_date,desc`, {
        headers: {'Authorization': token}
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message);
      }

      const pageData = await response.json();
      renderWishlist(pageData.content);
      renderPagination(pageData);

    } catch (error) {
      console.error('Error:', error);
      wishlistBody.innerHTML = `<tr><td colspan="4">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</td></tr>`;
    }
  }

  // ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
  function renderWishlist(items) {
    wishlistBody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
    if (items.length === 0) {
      wishlistBody.innerHTML = '<tr><td colspan="4">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ì— ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }

    items.forEach(item => {
      const row = `
                <tr>
                    <td>${item.product.name}</td>
                    <td>${item.product.price}ì›</td>
                    <td><img src="${item.product.imageUrl}" alt="ì´ë¯¸ì§€ ì—†ìŒ"/></td>
                    <td>
                        <button class="delete-from-wishlist-btn" data-wish-id="${item.id}">ì‚­ì œ</button>
                    </td>
                </tr>
            `;
      wishlistBody.innerHTML += row;
    });

    // ì‚­ì œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    addDeleteEventListeners();
  }

  // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§ í•¨ìˆ˜
  function renderPagination(pageData) {
    paginationControls.innerHTML = '';
    if (pageData.totalPages <= 1) {
      return;
    }

    let paginationHtml = '';

    // ì´ì „ í˜ì´ì§€
    if (!pageData.first) {
      paginationHtml += `<a href="#" onclick="fetchWishlist(${pageData.number
      - 1})">&laquo; ì´ì „</a>`;
    }

    // í˜„ì¬ í˜ì´ì§€
    paginationHtml += `<span>í˜ì´ì§€ <b>${pageData.number + 1}</b> / ${pageData.totalPages}</span>`;

    // ë‹¤ìŒ í˜ì´ì§€
    if (!pageData.last) {
      paginationHtml += `<a href="#" onclick="fetchWishlist(${pageData.number
      + 1})">ë‹¤ìŒ &raquo;</a>`;
    }

    paginationControls.innerHTML = paginationHtml;
  }

  // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ í•¨ìˆ˜
  function addDeleteEventListeners() {
    document.querySelectorAll('.delete-from-wishlist-btn').forEach(button => {
      button.addEventListener('click', async function () {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        const wishId = this.dataset.wishId;
        try {
          const response = await fetch(`/api/wishes/${wishId}`, {
            method: 'DELETE',
            headers: {'Authorization': token}
          });

          if (response.ok) {
            alert('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ì—ì„œ ìƒí’ˆì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
            fetchWishlist(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          } else {
            const error = await response.json();
            alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    });
  }

  // í˜ì´ì§€ ì²« ë¡œë“œ
  fetchWishlist(0);
</script>

</body>
</html>